name: Detect committed secrets

on:
  push:
    branches: [ master, main, '**' ]
  pull_request:

jobs:
  secret-scan:
    name: Scan for Supabase keys and common secret patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan repository for Supabase keys
        run: |
          set -euo pipefail
          echo "Scanning repository for Supabase keys and other secret-like strings..."
          # If git grep finds matches the exit code will be 0 and the if block will run
          if git grep -nE "SUPABASE_SERVICE_ROLE_KEY|NEXT_PUBLIC_SUPABASE_ANON_KEY|NEXT_PUBLIC_SUPABASE_URL|SUPABASE_ADMIN_ROLE|SUPABASE_SECRET" -- . ; then
            echo "::error::Potential Supabase keys or secrets found in the repository:" 
            git grep -nE "SUPABASE_SERVICE_ROLE_KEY|NEXT_PUBLIC_SUPABASE_ANON_KEY|NEXT_PUBLIC_SUPABASE_URL|SUPABASE_ADMIN_ROLE|SUPABASE_SECRET" -- .
            exit 1
          fi
