name: Detect committed secrets

on:
  push:
    branches: [ master, main, '**' ]
  pull_request:

jobs:
  secret-scan:
    name: Scan for Supabase keys and common secret patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan repository for Supabase keys
        run: |
          set -euo pipefail
          echo "Scanning repository for Supabase keys and other secret-like strings..."
          # Restrict scan to detect inline key assignments (e.g., SUPABASE_SERVICE_ROLE_KEY=<value>)
          # Skip docs and markdown files, since doc references of variable NAMES are intentionally present
          if git grep -nE "SUPABASE_SERVICE_ROLE_KEY=|NEXT_PUBLIC_SUPABASE_ANON_KEY=|NEXT_PUBLIC_SUPABASE_URL=" -- . ':(exclude)**/*.md' ':(exclude)docs/**' ':(exclude).github/workflows/**' ; then
            echo "::error::Potential Supabase keys or secrets found in the repository (non-docs):"
            git grep -nE "SUPABASE_SERVICE_ROLE_KEY=|NEXT_PUBLIC_SUPABASE_ANON_KEY=|NEXT_PUBLIC_SUPABASE_URL=" -- . ':(exclude)**/*.md' ':(exclude)docs/**' ':(exclude).github/workflows/**'
            exit 1
          fi
